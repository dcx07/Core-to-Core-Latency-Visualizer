<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C2C Latency Visualizer</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 2em;
        }
        h1 {
            color: #333;
        }
        textarea {
            width: 100%;
            max-width: 600px;
            height: 150px;
            margin-bottom: 1em;
        }
        button {
            padding: 10px 15px;
            font-size: 1em;
            cursor: pointer;
        }
        #heatmap {
            margin-top: 2em;
            overflow-x: auto;
        }
        .heatmap-container {
            display: grid;
            grid-template-columns: auto;
            grid-gap: 1px;
        }
        .heatmap-row {
            display: flex;
        }
        .heatmap-cell, .heatmap-label {
            width: 60px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px; /* Increased font size */
            box-sizing: border-box;
            transition: all 0.2s ease;
            position: relative;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .heatmap-cell {
            font-weight: bold;
            text-shadow: 0px 0px 3px rgba(0,0,0,0.7), 0px 0px 2px #fff; /* Stronger text shadow */
        }
        .heatmap-label {
            font-weight: bold;
            background-color: #f0f0f0;
        }
        .highlight-row .heatmap-cell {
            box-shadow: inset 0 0 0 2px rgba(255,255,255,0.5);
        }
        .highlight-col {
            box-shadow: inset 0 0 0 2px rgba(255,255,255,0.5);
        }
        .corner-label {
            width: 80px; /* 稍微宽一点，适应文本 */
        }
        .legend {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .legend-title {
            margin-bottom: 5px;
            font-weight: bold;
        }
        .legend-container {
            display: flex;
            align-items: center;
        }
        .legend-gradient {
            width: 300px;            /* restored */
            height: 20px;            /* restored */
            border: 1px solid #ccc;  /* restored */
            background: linear-gradient(to right,
                #440154,
                #472c7a,
                #3b518b,
                #2c718e,
                #21908d,
                #27ad81,
                #5cc863,
                #aadc32,
                #fde725
            );
        }
        .legend-labels {
            display: flex;
            justify-content: space-between;
            width: 300px;
            margin-top: 5px;
        }
        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            z-index: 100;
            pointer-events: none;
            white-space: nowrap;
            font-size: 12px;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .controls {
            margin: 1em 0;
        }
        .controls label {
            margin-right: 15px;
        }
        /* Add grid lines for better visualization */
        .heatmap-row:nth-child(4n+1) .heatmap-cell {
            border-top: 2px solid #666;
        }
        .heatmap-cell:nth-child(4n+1) {
            border-left: 2px solid #666;
        }
        /* Diagonal highlighting for same-core */
        .diagonal {
            background-image: linear-gradient(135deg, 
                rgba(255,255,255,0.3) 0%, 
                rgba(255,255,255,0.3) 49%, 
                rgba(0,0,0,0.1) 50%, 
                rgba(0,0,0,0.1) 100%);
        }
    </style>
</head>
<body>

    <h1>C2C Latency Visualizer</h1>
    <p>Paste your C2C latency data (comma-separated matrix format) below:</p>

    <textarea id="dataInput" placeholder="Paste your data here..."></textarea>
    <br>
    <button onclick="visualizeData()">Visualize</button>

    <div id="heatmap"></div>
    <div id="tooltip" class="tooltip"></div>

    <script>
        // --- Added color utility helpers (compact) ---
        function hexToRgb(hex) {
            const m = hex.replace('#','').match(/^([0-9a-f]{6})$/i);
            if(!m) return {r:0,g:0,b:0};
            const int = parseInt(m[1],16);
            return { r: (int>>16)&255, g: (int>>8)&255, b: int&255 };
        }
        function lerp(a,b,t){ return a + (b-a)*t; }
        function interpColor(c1, c2, t) {
            return {
                r: Math.round(lerp(c1.r,c2.r,t)),
                g: Math.round(lerp(c1.g,c2.g,t)),
                b: Math.round(lerp(c1.b,c2.b,t))
            };
        }
        function rgbToCss(c){ return `rgb(${c.r},${c.g},${c.b})`; }
        function luminance(c){ return 0.2126*c.r + 0.7152*c.g + 0.0722*c.b; }
        // Viridis-like stops (ordered low -> high)
        const VIRIDIS_STOPS = [
            '#440154','#472c7a','#3b518b','#2c718e',
            '#21908d','#27ad81','#5cc863','#aadc32','#fde725'
        ].map(hexToRgb);

        // Rewritten to return rgb + css (was returning only css)
        function getViridisColor(t){
            if (isNaN(t)) return { rgb:{r:200,g:200,b:200}, css:'rgb(200,200,200)' };
            t = Math.min(1, Math.max(0, t));
            const scaled = t * (VIRIDIS_STOPS.length - 1);
            const i = Math.floor(scaled);
            const f = scaled - i;
            if (i >= VIRIDIS_STOPS.length - 1) {
                const last = VIRIDIS_STOPS[VIRIDIS_STOPS.length - 1];
                return { rgb:last, css: rgbToCss(last) };
            }
            const c = interpColor(VIRIDIS_STOPS[i], VIRIDIS_STOPS[i+1], f);
            return { rgb:c, css: rgbToCss(c) };
        }

        function chooseTextColor(rgb, normalized){
            // Force dark text for very bright (upper 25%) but not pure black.
            const lum = luminance(rgb);
            if (normalized >= 0.75) return '#222';
            if (lum > 150) return '#222';
            return '#ffffff';
        }
        // --- End color utilities ---

        function visualizeData() {
            const dataString = document.getElementById('dataInput').value.trim();
            if (!dataString) {
                alert("Please paste your data into the text area first.");
                return;
            }

            try {
                const rows = dataString.split('\n');
                const zData = rows.map(row => 
                    row.split(',').map(val => {
                        const cleanedVal = val.trim().toLowerCase();
                        if (cleanedVal === 'x' || isNaN(parseFloat(cleanedVal))) {
                            return null; 
                        }
                        return parseFloat(cleanedVal);
                    })
                );

                const coreCount = zData.length;
                const labels = Array.from({length: coreCount}, (_, i) => `Core ${i}`);
                
                // Find min and max values for color scaling
                let minVal = Infinity;
                let maxVal = -Infinity;
                
                for (let i = 0; i < zData.length; i++) {
                    for (let j = 0; j < zData[i].length; j++) {
                        if (zData[i][j] !== null) {
                            minVal = Math.min(minVal, zData[i][j]);
                            maxVal = Math.max(maxVal, zData[i][j]);
                        }
                    }
                }
                
                if (minVal === Infinity) minVal = 0;
                if (maxVal === -Infinity) maxVal = 100;

                // Generate the heatmap HTML
                const heatmapContainer = document.createElement('div');
                heatmapContainer.className = 'heatmap-container';
                
                // Title
                const titleDiv = document.createElement('h2');
                titleDiv.textContent = 'Core-to-Core (C2C) Latency Heatmap';
                heatmapContainer.appendChild(titleDiv);
                
                // Header row with target core labels
                const headerRow = document.createElement('div');
                headerRow.className = 'heatmap-row';
                
                // Empty cell for the corner
                const cornerCell = document.createElement('div');
                cornerCell.className = 'heatmap-label corner-label';
                cornerCell.textContent = 'Source\\Target';
                headerRow.appendChild(cornerCell);
                
                // Add target core labels
                for (let j = 0; j < labels.length; j++) {
                    const labelCell = document.createElement('div');
                    labelCell.className = 'heatmap-label';
                    labelCell.textContent = labels[j];
                    labelCell.dataset.colIndex = j;
                    headerRow.appendChild(labelCell);
                }
                
                heatmapContainer.appendChild(headerRow);
                
                // Data rows
                for (let i = 0; i < zData.length; i++) {
                    const row = document.createElement('div');
                    row.className = 'heatmap-row';
                    row.dataset.rowIndex = i;
                    
                    // Source core label
                    const labelCell = document.createElement('div');
                    labelCell.className = 'heatmap-label corner-label';
                    labelCell.textContent = labels[i];
                    row.appendChild(labelCell);
                    
                    // Data cells
                    for (let j = 0; j < zData[i].length; j++) {
                        const cell = document.createElement('div');
                        cell.className = 'heatmap-cell';
                        cell.dataset.rowIndex = i;
                        cell.dataset.colIndex = j;
                        
                        const value = zData[i][j];
                        if (value !== null) {
                            const normalizedValue = (value - minVal) / (maxVal - minVal || 1);
                            const color = getViridisColor(normalizedValue);
                            cell.style.backgroundColor = color.css;
                            const textColor = chooseTextColor(color.rgb, normalizedValue);
                            cell.style.color = textColor;
                            cell.style.textShadow = textColor === '#ffffff'
                                ? '0 0 3px rgba(0,0,0,0.6)'
                                : '0 0 2px rgba(255,255,255,0.4)';
                            cell.textContent = value.toFixed(1);
                            cell.dataset.tooltip = `From Core ${i} to Core ${j}: ${value.toFixed(1)}ns`;
                            if (i === j) cell.classList.add('diagonal');
                        } else {
                            cell.style.backgroundColor = '#e4e4e4';
                            cell.style.color = '#555';
                            cell.textContent = 'X';
                        }
                        row.appendChild(cell);
                    }
                    
                    heatmapContainer.appendChild(row);
                }
                
                // Add legend
                const legendDiv = document.createElement('div');
                legendDiv.className = 'legend';
                
                const legendTitle = document.createElement('div');
                legendTitle.className = 'legend-title';
                legendTitle.textContent = 'Latency (ns)';
                legendDiv.appendChild(legendTitle);
                
                const legendContainer = document.createElement('div');
                legendContainer.className = 'legend-container';
                
                const legendGradient = document.createElement('div');
                legendGradient.className = 'legend-gradient';
                legendContainer.appendChild(legendGradient);
                
                legendDiv.appendChild(legendContainer);
                
                const legendLabels = document.createElement('div');
                legendLabels.className = 'legend-labels';
                
                const minLabel = document.createElement('span');
                minLabel.textContent = `${minVal.toFixed(1)} (Low)`;
                legendLabels.appendChild(minLabel);
                
                const maxLabel = document.createElement('span');
                maxLabel.textContent = `${maxVal.toFixed(1)} (High)`;
                legendLabels.appendChild(maxLabel);
                
                legendDiv.appendChild(legendLabels);
                heatmapContainer.appendChild(legendDiv);
                
                // Clear previous heatmap and add new one
                const heatmapDiv = document.getElementById('heatmap');
                heatmapDiv.innerHTML = '';
                heatmapDiv.appendChild(heatmapContainer);
                
                // Add event listeners for hover effects
                addHoverEffects();
                
            } catch (error) {
                alert("Failed to parse data. Please ensure it is in the correct comma-separated matrix format.");
                console.error(error);
            }
        }
        
        function addHoverEffects() {
            const tooltip = document.getElementById('tooltip');
            
            // Add hover effects to cells
            const cells = document.querySelectorAll('.heatmap-cell');
            cells.forEach(cell => {
                cell.addEventListener('mouseover', function(e) {
                    // Highlight row
                    const rowIndex = this.dataset.rowIndex;
                    document.querySelector(`.heatmap-row[data-row-index="${rowIndex}"]`).classList.add('highlight-row');
                    
                    // Highlight column
                    const colIndex = this.dataset.colIndex;
                    document.querySelectorAll(`.heatmap-cell[data-col-index="${colIndex}"]`).forEach(el => {
                        el.classList.add('highlight-col');
                    });
                    
                    // Show tooltip
                    if (this.dataset.tooltip) {
                        tooltip.textContent = this.dataset.tooltip;
                        tooltip.style.visibility = 'visible';
                        tooltip.style.opacity = 1;
                        tooltip.style.left = (e.pageX + 10) + 'px';
                        tooltip.style.top = (e.pageY + 10) + 'px';
                    }
                });
                
                cell.addEventListener('mousemove', function(e) {
                    tooltip.style.left = (e.pageX + 10) + 'px';
                    tooltip.style.top = (e.pageY + 10) + 'px';
                });
                
                cell.addEventListener('mouseout', function() {
                    // Remove highlights
                    const rowIndex = this.dataset.rowIndex;
                    document.querySelector(`.heatmap-row[data-row-index="${rowIndex}"]`).classList.remove('highlight-row');
                    
                    const colIndex = this.dataset.colIndex;
                    document.querySelectorAll(`.heatmap-cell[data-col-index="${colIndex}"]`).forEach(el => {
                        el.classList.remove('highlight-col');
                    });
                    
                    // Hide tooltip
                    tooltip.style.visibility = 'hidden';
                    tooltip.style.opacity = 0;
                });
            });
            
            // Also add column highlight to header labels
            const headerLabels = document.querySelectorAll('.heatmap-label[data-col-index]');
            headerLabels.forEach(label => {
                label.addEventListener('mouseover', function() {
                    const colIndex = this.dataset.colIndex;
                    document.querySelectorAll(`.heatmap-cell[data-col-index="${colIndex}"]`).forEach(el => {
                        el.classList.add('highlight-col');
                    });
                });
                
                label.addEventListener('mouseout', function() {
                    const colIndex = this.dataset.colIndex;
                    document.querySelectorAll(`.heatmap-cell[data-col-index="${colIndex}"]`).forEach(el => {
                        el.classList.remove('highlight-col');
                    });
                });
            });
        }
    </script>

</body>
</html>